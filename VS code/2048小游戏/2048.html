<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Document</title>
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <style>
        #header {
            width: 100%;
            margin: 0 auto;
            text-align: center;
        }

        #header .title1 {
            font: bold 85px Arial;
            color: #776e65;
            margin: 0 auto;
            filter: drop-shadow(4px 4px 8px rgb(235, 140, 140));
        }

        #header .title2 {
            font: normal 18px Arial;
            margin: 10px auto;
            padding-left: 20%;
        }

        #header .wrapper {
            display: flex;
            justify-content: space-between;
            width: 500px;
            margin: 0 auto;
        }

        #header .score-wrapper {
            background-color: #8f7a66;
            padding: 6px;
            border-radius: 6px;
            font-size: 30px;
        }

        #header .score-wrapper #txt {
            color: #d2c1c1;
        }

        #header .score-wrapper #score {
            color: #fff;
        }

        #header .newgame-wrapper #newGame {
            width: 100px;
            display: block;
            background-color: #8f7a66;
            text-decoration: none;
            padding: 13px;
            border-radius: 6px;
            color: #fff;
            font: bold 15px Arial;
        }

        #header .newgame-wrapper #newGame:hover {
            background-color: #bdac9c;
        }

        #grid-container {
            width: 460px;
            height: 460px;
            padding: 20px;
            background-color: #bbada0;
            margin: 10px auto;
            border-radius: 10px;
            position: relative;
        }

        #grid-container .grid-cell {
            width: 100px;
            height: 100px;
            background-color: #ccc0b3;
            border-radius: 6px;
            position: absolute;
        }

        #grid-container .number-cell {
            border-radius: 6px;
            position: absolute;
            background-color: red;
            font: bold 50px Arial;
            text-align: center;
            line-height: 100px;
        }
    </style>
    <script>
        //界面设计
        var documentWidth = document.documentElement.clientWidth; //页面DOM的宽度
        var containerWidth = documentWidth * 0.92; //容器的宽度
        var cellWidth = documentWidth * 0.18;
        var cellSpace = documentWidth * 0.04;
        console.log(documentWidth, containerWidth, cellWidth, cellSpace);

        //获取上边的位置
        function getPosTop(i, j) {
            return cellSpace + (cellWidth + cellSpace) * i;
        }

        //获取左边的位置
        function getPosLeft(i, j) {
            return cellSpace + (cellWidth + cellSpace) * j;
        }

        //获取数字背景的颜色
        function getNumberBackgroundColor(num) {
            switch (num) {
                case 2:
                    return "#eee4da";
                    break;
                case 4:
                    return "#ede0c8";
                    break;
                case 8:
                    return "#f2b179";
                    break;
                case 16:
                    return "#f59563";
                    break;
                case 32:
                    return "#f67c5f";
                    break;
                case 64:
                    return "#f65e3b";
                    break;
                case 128:
                    return "#edcf72";
                    break;
                case 256:
                    return "#edcc61";
                    break;
                case 512:
                    return "#9c0";
                    break;
                case 1024:
                    return "#33b5e5";
                    break;
                case 2048:
                    return "#09c";
                    break;
                case 4096:
                    return "#a6c";
                    break;
                case 8192:
                    return "#93c";
                    break;
            }
        }

        //获取数字颜色
        function getNumberColor(num) {
            if (num <= 4) {
                return "#776e65";
            } else {
                return "#fff";
            }
        }

        //判断是否没有空间
        function nospace(nums) {
            for (var i = 0; i < 4; i++) {
                for (var j = 0; j < 4; j++) {
                    if (nums[i][j] == 0) {
                        return false;
                    }
                }
            }
            return true;
        }

        //向左移动
        function canMoveLeft(nums) {
            for (var i = 0; i < 4; i++) {
                for (var j = 1; j < 4; j++) {
                    if (nums[i][j] != 0) {
                        if (nums[i][j - 1] == 0 || nums[i][j - 1] == nums[i][j]) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }

        //向上移动
        function canMoveUp(nums) {
            for (var i = 1; i < 4; i++) {
                for (var j = 0; j < 4; j++) {
                    if (nums[i][j] != 0) {
                        if (nums[i - 1][j] == 0 || nums[i - 1][j] == nums[i][j]) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }

        //向右移动
        function canMoveRight(nums) {
            for (var i = 0; i < 4; i++) {
                for (var j = 0; j < 3; j++) {
                    if (nums[i][j] != 0) {
                        if (nums[i][j + 1] == 0 || nums[i][j + 1] == nums[i][j]) {
                            //向右移动应该是+符号
                            return true;
                        }
                    }
                }
            }
            return false;
        }

        //向下移动
        function canMoveDown(nums) {
            for (var i = 0; i < 3; i++) {
                for (var j = 0; j < 4; j++) {
                    if (nums[i][j] != 0) {
                        if (nums[i + 1][j] == 0 || nums[i + 1][j] == nums[i][j]) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }

        //判断水平方向上是否没有障碍物
        function noBlockHorizontal(row, col1, col2, nums) {
            for (var i = col1 + 1; i < col2; i++) {
                if (nums[row][i] != 0) {
                    return false;
                }
            }
            return true;
        }

        //判断垂直方向上是否没有障碍物
        function noBlockVertical(col, row1, row2, nums) {
            for (var i = row1 + 1; i < row2; i++) {
                if (nums[i][col] != 0) {
                    return false;
                }
            }
            return true;
        }

        //更新分数
        function updateScore(score) {
            $("#score").text(score);
        }

        //判断是否不能移动
        function noMove(nums) {
            if (
                canMoveLeft(nums) ||
                canMoveUp(nums) ||
                canMoveRight(nums) ||
                canMoveDown(nums)
            ) {
                return false;
            }
            return true;
        }

        //判断游戏是否结束，两个条件1.没有空的单元格 2.不能移动

        function IsGameOver() {
            if (nospace(nums) && noMove(nums)) {
                flag = confirm("Game Over!\n是否重新开始");
                if (flag) newgame();
            }
        }

        //通过动画显示数字
        function showNumberWihthAnimation(i, j, randNumber) {
            var numberCell = $("#number-cell-" + i + "-" + j);
            numberCell.css(
                "background-color",
                getNumberBackgroundColor(randNumber)
            );
            numberCell.css("color", getNumberColor(randNumber));
            numberCell.css("filter", "drop-shadow(0 0 10px lightyellow");
            numberCell.text(randNumber);

            numberCell.animate(
                {
                    width: cellWidth,
                    height: cellWidth,
                    top: getPosTop(i, j),
                    left: getPosLeft(i, j),
                },
                500
            );
        }

        //通过动画显示移动的效果
        function showMoveAnimation(fromx, fromy, tox, toy) {
            var numberCell = $("#number-cell-" + fromx + "-" + fromy);
            numberCell.animate(
                {
                    top: getPosTop(tox, toy),
                    left: getPosLeft(tox, toy),
                },
                200
            );
        }
    </script>
</head>
<body>
<div id="header">
    <h1 class="title1">2048</h1>
    <br/>
    <div class="wrapper">
        <div class="score-wrapper">
            <span id="txt">score:</span>
            <span id="score">0</span>
        </div>
        <div class="newgame-wrapper">
            <a href="javascript:newgame()" id="newGame">New Game</a>
        </div>
    </div>
</div>
<div id="grid-container">
    <div class="grid-cell" id="grid-cell-0-0"></div>
    <div class="grid-cell" id="grid-cell-0-1"></div>
    <div class="grid-cell" id="grid-cell-0-2"></div>
    <div class="grid-cell" id="grid-cell-0-3"></div>

    <div class="grid-cell" id="grid-cell-1-0"></div>
    <div class="grid-cell" id="grid-cell-1-1"></div>
    <div class="grid-cell" id="grid-cell-1-2"></div>
    <div class="grid-cell" id="grid-cell-1-3"></div>

    <div class="grid-cell" id="grid-cell-2-0"></div>
    <div class="grid-cell" id="grid-cell-2-1"></div>
    <div class="grid-cell" id="grid-cell-2-2"></div>
    <div class="grid-cell" id="grid-cell-2-3"></div>

    <div class="grid-cell" id="grid-cell-3-0"></div>
    <div class="grid-cell" id="grid-cell-3-1"></div>
    <div class="grid-cell" id="grid-cell-3-2"></div>
    <div class="grid-cell" id="grid-cell-3-3"></div>
</div>
</body>
<script>
    var nums = new Array();
    var score = 0;
    var hasConflicted = new Array(); //表示是否已叠加，用来解决重复问题

    var startx = 0;
    var starty = 0;
    var endx = 0;
    var endy = 0;

    $(document).ready(function () {
        newgame();
    });

    //开始新游戏
    function newgame() {
        containerWidth = 500;
        cellWidth = 100;
        cellSpace = 20;

        init();

        //在随机的两个单元格生成数字
        generateOneNumber();
        generateOneNumber();
    }

    //初始化页面
    function init() {
        //初始化单元格位置
        for (var i = 0; i < 4; i++) {
            for (var j = 0; j < 4; j++) {
                var gridCell = $("#grid-cell-" + i + "-" + j);
                gridCell.css("top", getPosTop(i, j));
                gridCell.css("left", getPosLeft(i, j));
            }
        }

        //初始化数组  使所有数组都默认为0
        for (var i = 0; i < 4; i++) {
            nums[i] = new Array();
            hasConflicted[i] = new Array();
            for (var j = 0; j < 4; j++) {
                nums[i][j] = 0;
                hasConflicted[i][j] = false; //false表示未曾叠加过，true表示已经叠加过
            }
        }

        //动态创建上层单元格初始化
        updateView();

        score = 0;
        updateScore(score);
    }

    //更新上层单元格视图
    function updateView() {
        //将上层所有单元格清空，然后重新初始化创建
        $(".number-cell").remove();

        for (var i = 0; i < 4; i++) {
            for (var j = 0; j < 4; j++) {
                $("#grid-container").append(
                    '<div class="number-cell" id="number-cell-' +
                    i +
                    "-" +
                    j +
                    '"></div>'
                );

                var numberCell = $("#number-cell-" + i + "-" + j);
                if (nums[i][j] == 0) {
                    numberCell.css("width", "0px");
                    numberCell.css("height", "0px");
                    numberCell.css("top", getPosTop(i, j) + cellWidth * 0.5);
                    numberCell.css("left", getPosLeft(i, j) + cellWidth * 0.5);
                } else {
                    numberCell.css("width", cellWidth);
                    numberCell.css("height", cellWidth);
                    numberCell.css("top", getPosTop(i, j));
                    numberCell.css("left", getPosLeft(i, j));
                    numberCell.css(
                        "background-color",
                        getNumberBackgroundColor(nums[i][j])
                    );
                    numberCell.css("color", getNumberColor(nums[i][j]));
                    numberCell.text(nums[i][j]);
                }
                hasConflicted[i][j] = false; //初始化默认该值未曾叠加过
            }
        }
    }

    /*
	在随机的单元格中生成一个随机数：
	1.在空余的单元格当中随机找一个（先判断单元格是否为空）
	2.随机产生一个2或者4
*/
    function generateOneNumber() {
        //判断是否还有空间，如果没有空间则直接返回
        if (nospace(nums)) {
            return;
        }

        //随机一个位置
        var count = 0;
        var temp = new Array();
        for (var i = 0; i < 4; i++) {
            for (var j = 0; j < 4; j++) {
                if (nums[i][j] == 0) {
                    temp[count] = i * 4 + j; //方便获取 i和j的坐标位置
                    count++;
                }
            }
        }
        var pos = Math.floor(Math.random() * count); //[0,1)*6=[0,5]

        var randx = Math.floor(temp[pos] / 4);
        var randy = Math.floor(temp[pos] % 4);

        //随机一个数字
        var randNum = Math.random() < 0.2 ? 2 : 4;

        //在随机位置上显示随机数字
        nums[randx][randy] = randNum;
        showNumberWihthAnimation(randx, randy, randNum);
    }

    function debounce(fn, wait) {
        var timer = null;
        return function () {
            if (timer !== null) {
                clearTimeout(timer);
            }
            timer = setTimeout(fn, wait);
        };
    }

    //实现键盘的响应
    $(document).keydown(function (event) {
        //阻止事件的默认行为
        // event.preventDefault();

        switch (event.keyCode) {
            case 65:
            case 37: //left
                //判断是否可以向左移动
                if (canMoveLeft(nums)) {
                    let p = new Promise((resolve, reject) => {
                        moveLeft();
                        resolve();
                    });
                    p.then((result) => {
                        setTimeout(generateOneNumber, 500);
                    }).then(() => {
                        setTimeout(IsGameOver, 500);
                    });
                }
                break;
            case 87:
            case 38: //up
                if (canMoveUp(nums)) {
                    let p = new Promise((resolve, reject) => {
                        moveUp();
                        resolve();
                    });
                    p.then((result) => {
                        setTimeout(generateOneNumber, 500);
                    }).then(() => {
                        setTimeout(IsGameOver, 500);
                    });
                }
                break;
            case 68:
            case 39: //right
                if (canMoveRight(nums)) {
                    let p = new Promise((resolve, reject) => {
                        moveRight();
                        resolve();
                    });
                    p.then((result) => {
                        setTimeout(generateOneNumber, 500);
                    }).then(() => {
                        setTimeout(IsGameOver, 500);
                    });
                }
                break;
            case 83:
            case 40: //down
                if (canMoveDown(nums)) {
                    let p = new Promise((resolve, reject) => {
                        moveDown();
                        resolve();
                    });
                    p.then((result) => {
                        setTimeout(generateOneNumber, 500);
                    }).then(() => {
                        setTimeout(IsGameOver, 500);
                    });
                }
                break;
            default:
                break;
        }
    });

    /*
	向左移动
	需要对每一个数字的左边进行判断，选择合适的落脚点，落脚点有两种情况：
		1.落脚点没有数字，且移动的路径中没有阻碍物
		2.落脚点的数字和自己相同，且移动路径中没有障碍物
*/
    function moveLeft() {
        for (var i = 0; i < 4; i++) {
            for (var j = 0; j < 4; j++) {
                //j已经在最左边 所以从1开始
                if (nums[i][j] != 0) {
                    for (var k = 0; k < j; k++) {
                        if (nums[i][k] == 0 && noBlockHorizontal(i, k, j, nums)) {
                            //第I行的地k-j列是否有障碍物
                            //移动操作
                            showMoveAnimation(i, j, i, k);
                            nums[i][k] = nums[i][j];
                            nums[i][j] = 0;
                            break;
                        } else if (
                            nums[i][k] == nums[i][j] &&
                            noBlockHorizontal(i, k, j, nums) &&
                            !hasConflicted[i][k]
                        ) {
                            //进行叠加
                            showMoveAnimation(i, j, i, k);
                            nums[i][k] += nums[i][j];
                            nums[i][j] = 0;
                            //统计分数
                            score += nums[i][k];
                            updateScore(score);

                            hasConflicted[i][k] = true; //表示已经叠加
                            break;
                        }
                    }
                }
            }
        }

        //更新页面上的数字单元格
        setTimeout(updateView, 200); //等待200ms，为了让单元格移动效果能够显示完
    }

    function moveUp() {
        for (var j = 0; j < 4; j++) {
            for (var i = 1; i < 4; i++) {
                if (nums[i][j] != 0) {
                    for (var k = 0; k < i; k++) {
                        if (nums[k][j] == 0 && noBlockVertical(j, k, i, nums)) {
                            //第j列的第k-i行之间是否有障碍物
                            showMoveAnimation(i, j, k, j);
                            nums[k][j] = nums[i][j];
                            nums[i][j] = 0;
                            break;
                        } else if (
                            nums[k][j] == nums[i][j] &&
                            noBlockVertical(j, k, i, nums) &&
                            !hasConflicted[k][j]
                        ) {
                            showMoveAnimation(i, j, k, j);
                            nums[k][j] += nums[i][j];
                            nums[i][j] = 0;
                            score += nums[k][j];
                            updateScore(score);

                            hasConflicted[k][j] = true;
                            break;
                        }
                    }
                }
            }
        }

        //更新页面上的数字单元格
        setTimeout(updateView, 200); //等待500ms，为了让单元格移动效果能够显示完
    }

    function moveRight() {
        for (var i = 0; i < 4; i++) {
            for (var j = 2; j >= 0; j--) {
                //j已经在最右边 所以没有3的挤压
                if (nums[i][j] != 0) {
                    for (var k = 3; k > j; k--) {
                        if (nums[i][k] == 0 && noBlockHorizontal(i, j, k, nums)) {
                            //第i行的地j-k列是否有障碍物
                            //移动操作
                            showMoveAnimation(i, j, i, k);
                            nums[i][k] = nums[i][j];
                            nums[i][j] = 0;
                            break;
                        } else if (
                            nums[i][k] == nums[i][j] &&
                            noBlockHorizontal(i, j, k, nums) &&
                            !hasConflicted[i][k]
                        ) {
                            //进行叠加
                            showMoveAnimation(i, j, i, k);
                            nums[i][k] += nums[i][j];
                            nums[i][j] = 0;
                            //统计分数
                            score += nums[i][k];
                            updateScore(score);

                            hasConflicted[i][k] = true; //表示已经叠加
                            break;
                        }
                    }
                }
            }
        }

        //更新页面上的数字单元格
        setTimeout(updateView, 200); //等待200ms，为了让单元格移动效果能够显示完
    }

    function moveDown() {
        for (var j = 0; j < 4; j++) {
            for (var i = 2; i >= 0; i--) {
                if (nums[i][j] != 0) {
                    for (var k = 3; k > i; k--) {
                        if (nums[k][j] == 0 && noBlockVertical(j, i, k, nums)) {
                            //第j列的第i-k行之间是否有障碍物
                            showMoveAnimation(i, j, k, j);
                            nums[k][j] = nums[i][j];
                            nums[i][j] = 0;
                            break;
                        } else if (
                            nums[k][j] == nums[i][j] &&
                            noBlockVertical(j, i, k, nums) &&
                            !hasConflicted[k][j]
                        ) {
                            showMoveAnimation(i, j, k, j);
                            nums[k][j] += nums[i][j];
                            nums[i][j] = 0;
                            score += nums[k][j];
                            updateScore(score);

                            hasConflicted[k][j] = true;
                            break;
                        }
                    }
                }
            }
        }
        //更新页面上的数字单元格
        setTimeout(updateView, 200); //等待200ms，为了让单元格移动效果能够显示完
    }
</script>
</html>
